<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾ç²è€å¸« 2026 æ–°å¹´å¿«æ¨‚ï¼</title>
    <style>
        /* ä¿æŒåŸæœ¬çš„ CSS æ¨£å¼ï¼Œé€™è£¡çœç•¥é‡è¤‡éƒ¨åˆ†ä»¥ç¯€çœç‰ˆé¢ï¼Œè«‹ä½¿ç”¨ä¸Šä¸€ç‰ˆçš„ CSS */
        /* ç‚ºæ–¹ä¾¿è¤‡è£½ï¼Œæˆ‘å°‡æ ¸å¿ƒ CSS ä¿ç•™åœ¨é€™è£¡ */
        :root { --primary-color: #ff6b6b; --secondary-color: #feca57; --bg-color: #fff0f0; --card-bg: #ffffff; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 40px; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.2); border: 2px solid var(--primary-color); }
        h1 { color: var(--primary-color); margin: 0; font-size: 2.5em; }
        .input-section { background: var(--card-bg); padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], textarea, input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 12px 25px; font-size: 1.1em; border-radius: 50px; cursor: pointer; width: 100%; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .wall-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .card { background: var(--card-bg); border-radius: 15px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid var(--secondary-color); }
        .card img, .card video { width: 100%; border-radius: 10px; margin-bottom: 10px; }
        .card-name { font-weight: bold; color: var(--primary-color); margin-bottom: 5px; }
        .card-text { font-size: 0.95em; line-height: 1.5; color: #444; white-space: pre-wrap; }
        .timestamp { font-size: 0.8em; color: #999; margin-top: 10px; text-align: right; }
        
        /* Loading å‹•ç•« */
        .loading { text-align: center; display: none; margin-bottom: 15px; color: var(--primary-color); font-weight: bold;}
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ‰ ç¾ç²è€å¸« 2026 æ–°å¹´å¿«æ¨‚ï¼</h1>
        <p>è¦ªæ„›çš„åŒå­¸å€‘èˆ‡å®¶é•·ï¼Œè«‹åœ¨é€™è£¡ç•™ä¸‹çµ¦è€å¸«çš„ç¥ç¦ â¤ï¸</p>
    </header>

    <div class="input-section">
        <div class="form-group">
            <label>æˆ‘æ˜¯èª° (å­¸ç”Ÿæˆ–å®¶é•·å§“å)</label>
            <input type="text" id="nameInput" placeholder="ä¾‹å¦‚ï¼šå°æ˜åª½åª½ / 203ç­ ç‹å°ç¾">
        </div>
        <div class="form-group">
            <label>ç¥ç¦çš„è©±</label>
            <textarea id="messageInput" rows="3" placeholder="è€å¸«æ–°å¹´å¿«æ¨‚ï¼Œè¬è¬æ‚¨çš„æ•™å°..."></textarea>
        </div>
        <div class="form-group">
            <label>ä¸Šå‚³ç…§ç‰‡æˆ–å½±ç‰‡ (é¸å¡«ï¼Œå½±ç‰‡è«‹å‹¿è¶…é 10MB ä»¥å…å‚³è¼¸éä¹…)</label>
            <input type="file" id="fileInput" accept="image/*,video/*">
        </div>
        <div id="loadingText" class="loading">æ­£åœ¨ä¸Šå‚³ä¸­ï¼Œè«‹ç¨å€™... ğŸš€</div>
        <button id="submitBtn">ç™¼é€ç¥ç¦</button>
    </div>

    <div id="blessingWall" class="wall-grid">
        <p style="text-align:center; width:100%; color:#999;">è¼‰å…¥ç¥ç¦ä¸­...</p>
    </div>
</div>

<script type="module">
    // 1. å¼•å…¥å¿…è¦çš„ Firebase å‡½å¼åº«
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // 2. è¨­å®š Firebase Config
    // ğŸ”¥ğŸ”¥ è«‹å°‡ä½ çš„ firebaseConfig è²¼åœ¨ä¸‹é¢å–ä»£é€™å€‹å€å¡Š ğŸ”¥ğŸ”¥
    const firebaseConfig = {
        apiKey: "ä½ çš„_API_KEY",
        authDomain: "ä½ çš„å°ˆæ¡ˆID.firebaseapp.com",
        projectId: "ä½ çš„å°ˆæ¡ˆID",
        storageBucket: "ä½ çš„å°ˆæ¡ˆID.appspot.com",
        messagingSenderId: "ä½ çš„SenderID",
        appId: "ä½ çš„AppID"
    };
    // ğŸ”¥ğŸ”¥ çµæŸ ğŸ”¥ğŸ”¥

    // 3. åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const wallDiv = document.getElementById('blessingWall');
    const submitBtn = document.getElementById('submitBtn');
    const loadingText = document.getElementById('loadingText');

    // 4. å³æ™‚ç›£è½è³‡æ–™åº«è®ŠåŒ– (Read)
    const q = query(collection(db, "blessings"), orderBy("timestamp", "desc"));
    
    onSnapshot(q, (snapshot) => {
        wallDiv.innerHTML = ""; // æ¸…ç©ºç›®å‰é¡¯ç¤º
        if (snapshot.empty) {
            wallDiv.innerHTML = '<p style="text-align:center; width:100%; color:#999;">ç›®å‰é‚„æ²’æœ‰ç¥ç¦ï¼Œæ¶é ­é¦™å§ï¼</p>';
            return;
        }

        snapshot.forEach((doc) => {
            const data = doc.data();
            renderCard(data);
        });
    });

    // 5. æ¸²æŸ“å¡ç‰‡å‡½æ•¸
    function renderCard(data) {
        const card = document.createElement('div');
        card.className = 'card';
        
        let mediaHtml = '';
        if (data.fileUrl) {
            if (data.fileType && data.fileType.startsWith('video')) {
                mediaHtml = `<video src="${data.fileUrl}" controls></video>`;
            } else {
                mediaHtml = `<img src="${data.fileUrl}" alt="ç¥ç¦åœ–ç‰‡">`;
            }
        }

        // è½‰æ›æ™‚é–“æˆ³è¨˜
        let dateStr = "å‰›å‰›";
        if (data.timestamp) {
            dateStr = new Date(data.timestamp.seconds * 1000).toLocaleString();
        }

        card.innerHTML = `
            ${mediaHtml}
            <div class="card-name">${escapeHtml(data.name)}</div>
            <div class="card-text">${escapeHtml(data.message)}</div>
            <div class="timestamp">${dateStr}</div>
        `;
        wallDiv.appendChild(card);
    }

    // 6. è™•ç†ç™¼é€ç¥ç¦ (Create + Upload)
    submitBtn.addEventListener('click', async () => {
        const name = document.getElementById('nameInput').value;
        const message = document.getElementById('messageInput').value;
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];

        if (name.trim() === "" || message.trim() === "") {
            alert("è«‹å¡«å¯«åå­—å’Œç¥ç¦å…§å®¹å–”ï¼");
            return;
        }

        // UI é€²å…¥è¼‰å…¥ç‹€æ…‹
        submitBtn.disabled = true;
        submitBtn.innerText = "è™•ç†ä¸­...";
        loadingText.style.display = "block";

        try {
            let fileUrl = "";
            let fileType = "";

            // å¦‚æœæœ‰æª”æ¡ˆï¼Œå…ˆä¸Šå‚³åˆ° Storage
            if (file) {
                const storageRef = ref(storage, 'blessings/' + Date.now() + '_' + file.name);
                const snapshot = await uploadBytes(storageRef, file);
                fileUrl = await getDownloadURL(snapshot.ref);
                fileType = file.type;
            }

            // å¯«å…¥è³‡æ–™åº«
            await addDoc(collection(db, "blessings"), {
                name: name,
                message: message,
                fileUrl: fileUrl,
                fileType: fileType,
                timestamp: serverTimestamp()
            });

            // é‡ç½®è¡¨å–®
            document.getElementById('nameInput').value = '';
            document.getElementById('messageInput').value = '';
            document.getElementById('fileInput').value = '';
            alert("ç¥ç¦ç™¼é€æˆåŠŸï¼");

        } catch (e) {
            console.error("Error adding document: ", e);
            alert("ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚(" + e.message + ")");
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "ç™¼é€ç¥ç¦";
            loadingText.style.display = "none";
        }
    });

    // é˜² XSS æ”»æ“Š
    function escapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>

</body>
</html>
